<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connectivity Check</title>
</head>

<body>
    <div id="status">Checking...</div>
    <div id="loadingScreen">Loading...</div>
    <div id="mainContent" class="hidden">Main Content</div>
    <div id="offlineMessage" class="hidden">You are offline</div>

    <script>
        const checkInterval = 5000; // Interval to check connectivity in milliseconds
        const testUrl = 'https://www.google.com/'; // URL to test connectivity
        let isChecking = false; // Flag to manage ongoing fetch requests
        let timeoutHandle = null; // Handle for the timeout
        let checkAttempts = 0; // Counter for the number of checks
        const maxAttempts = 10; // Maximum number of attempts

        // Function to perform a fetch request to test connectivity
        function checkInternetConnectivity() {
            if (isChecking) return; // Exit if a check is already in progress
            isChecking = true;

            // Clear any previous timeout to ensure it's reset
            if (timeoutHandle) {
                clearTimeout(timeoutHandle);
            }

            // Create a new timeout for the 2-second delay
            timeoutHandle = setTimeout(() => {
                // Update status to offline if fetch is not completed in 2 seconds
                handleOffline();
                isChecking = false;
            }, 1000);

            // Perform the fetch request
            fetch(testUrl, { method: 'HEAD', mode: 'no-cors' })
                .then(response => {
                    // If fetch completes within 2 seconds, clear timeout and update status to online
                    clearTimeout(timeoutHandle);
                    checkAttempts = 0; // Reset attempts on successful fetch
                    const statusElement = document.getElementById('status');
                    statusElement.innerText = 'Online';
                    statusElement.style.color = 'lightgreen';
                    console.log('online');
                })
                .catch(error => {
                    // If fetch fails, clear timeout and handle offline status
                    clearTimeout(timeoutHandle);
                    checkAttempts++;
                    if (checkAttempts >= maxAttempts) {
                        callOfflineEndpoint();
                    }
                })
                .finally(() => {
                    isChecking = false; // Reset the flag once the fetch completes
                });
        }

        // Function to handle offline status
        function handleOffline() {
            console.log('Offline');
            const statusElement = document.getElementById('status');
            statusElement.innerText = 'Offline';
            statusElement.style.color = 'red';
        }

        // Function to call the offline endpoint
        function callOfflineEndpoint() {
            handleOffline();
            window.location.href = 'http://localhost:5000/offline';
            fetch('http://localhost:5000/offline')
                .then(response => console.log('Offline endpoint called'))
                .catch(error => console.error('Error calling offline endpoint', error));
        }

        // Function to check network status
        function checkNetworkStatus() {
            checkInternetConnectivity();
        }

        // Periodically check network status
        setInterval(checkNetworkStatus, checkInterval);

        // Initial check on page load
        window.onload = checkNetworkStatus;

    </script>
</body>

</html>